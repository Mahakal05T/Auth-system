<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>User Dashboard</title>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root { --brand: #4f46e5; } /* indigo-600 */
    html, body { font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .fade-slide { animation: fadeSlide 360ms ease both; }
    @keyframes fadeSlide {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .avatar-bg {
      background: linear-gradient(135deg, rgba(79,70,229,0.12), rgba(79,70,229,0.06));
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

  <!-- Top navbar -->
  <nav class="bg-white border-b shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <!-- Left: Brand -->
        <div class="flex items-center gap-3">
          <a href="/" class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-600 to-indigo-400 flex items-center justify-center text-white shadow">
              <!-- simple logo -->
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12h18M3 6h18M3 18h18"/></svg>
            </div>
            <div class="text-lg font-semibold text-gray-900">YourApp</div>
          </a>
        </div>

        <!-- Right: User area -->
        <div class="flex items-center gap-4">
          <div class="hidden sm:flex sm:items-center sm:gap-4">
            <div class="text-sm text-gray-600">Last login</div>
            <div class="text-sm font-medium text-gray-800">
              {{ user.last_login.strftime('%d %b %Y %H:%M') if user.last_login else '‚Äî' }}
            </div>
          </div>

          <div class="flex items-center gap-3">
            <div class="flex items-center gap-3 px-3 py-1 rounded-full bg-indigo-50">
              <div class="w-9 h-9 rounded-full avatar-bg flex items-center justify-center text-indigo-700 font-semibold">
                {{ user.name[0] if user.name else 'U' }}
              </div>
              <div class="hidden sm:block text-sm">
                <div class="text-gray-700">Hi, <span class="font-semibold">{{ user.name }}</span> üëã</div>
                <div class="text-xs text-gray-500">{{ user.role | capitalize }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Profile summary (left column on large screens) -->
      <section class="lg:col-span-1">
        <div class="bg-white rounded-2xl shadow-sm p-6 fade-slide">
          <div class="flex items-start gap-4">
            <div class="w-16 h-16 rounded-xl avatar-bg flex items-center justify-center text-indigo-700 text-2xl font-bold">
              {{ user.name[0] if user.name else 'U' }}
            </div>
            <div>
              <h2 class="text-xl font-semibold text-gray-900">{{ user.name }}</h2>
              <p class="text-sm text-gray-500 mt-1">Employee ID: <span class="font-medium text-gray-700">{{ user.emp_id }}</span></p>
            </div>
          </div>

          <div class="mt-6 space-y-3">
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-500">Email</div>
              <div class="text-sm font-medium text-gray-700">{{ user.email }}</div>
            </div>
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-500">Phone</div>
              <div class="text-sm font-medium text-gray-700">{{ user.phone }}</div>
            </div>
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-500">Department</div>
              <div class="text-sm font-medium text-gray-700">{{ user.department or '‚Äî' }}</div>
            </div>
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-500">Role</div>
              <div class="text-sm font-medium text-gray-700">{{ user.role | capitalize }}</div>
            </div>
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-500">Status</div>
              <div class="text-sm font-medium">
                {% if user.status %}
                  <span class="inline-flex items-center gap-2 px-2 py-1 rounded-full bg-green-100 text-green-700 text-xs">‚óè Active</span>
                {% else %}
                  <span class="inline-flex items-center gap-2 px-2 py-1 rounded-full bg-gray-100 text-gray-700 text-xs">‚óè Inactive</span>
                {% endif %}
              </div>
            </div>
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-500">Last login</div>
              <div class="text-sm font-medium text-gray-700">{{ user.last_login.strftime('%d %b %Y') if user.last_login else '‚Äî' }}</div>
            </div>
          </div>

          <div class="mt-6 flex gap-3">
            <button id="editProfileBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Edit Profile</button>
            <a href="#" id="logoutLink" class="inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm bg-white border hover:shadow-sm">
              <i data-lucide="log-out" class="w-4 h-4 text-gray-600"></i>
              <span class="text-gray-700">Logout</span>
            </a>
          </div>
        </div>

        <!-- Small quick actions -->
        <div class="mt-4 grid grid-cols-1 gap-4">
          <div class="bg-white rounded-2xl shadow-sm p-4 fade-slide">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm text-gray-500">Account created</div>
                <div class="text-sm font-medium text-gray-700">{{ user.created_at.strftime('%d %b %Y') if user.created_at else '‚Äî' }}</div>
              </div>
              <div>
                <i data-lucide="calendar" class="w-6 h-6 text-indigo-500"></i>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-2xl shadow-sm p-4 fade-slide">
            <div class="flex items-start gap-3">
              <div class="flex-1">
                <div class="text-sm text-gray-500">Security</div>
                <div class="text-sm font-medium text-gray-700">2-factor & permissions</div>
              </div>
              <div>
                <i data-lucide="shield" class="w-6 h-6 text-indigo-500"></i>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Right column: forms and content -->
      <section class="lg:col-span-2 space-y-6">

        <!-- Update profile card -->
        <div class="bg-white rounded-2xl shadow-sm p-6 fade-slide">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">Update Profile</h3>
            <div class="text-sm text-gray-500">Make changes to your basic info</div>
          </div>

          <!-- Profile display (initial) -->
          <div id="userInfo" class="mt-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="p-4 bg-gray-50 rounded-lg">
                <div class="text-xs text-gray-500">Full name</div>
                <div class="text-sm font-medium text-gray-800">{{ user.name }}</div>
              </div>
              <div class="p-4 bg-gray-50 rounded-lg">
                <div class="text-xs text-gray-500">Employee ID</div>
                <div class="text-sm font-medium text-gray-800">{{ user.emp_id }}</div>
              </div>
              <div class="p-4 bg-gray-50 rounded-lg">
                <div class="text-xs text-gray-500">Email</div>
                <div class="text-sm font-medium text-gray-800">{{ user.email }}</div>
              </div>
              <div class="p-4 bg-gray-50 rounded-lg">
                <div class="text-xs text-gray-500">Phone</div>
                <div class="text-sm font-medium text-gray-800">{{ user.phone }}</div>
              </div>
            </div>
          </div>

          <!-- Profile edit form (hidden until edit) -->
          <form id="profileForm" class="hidden mt-4 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <input id="profile_name" name="name" type="text" required class="border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-300" placeholder="Full name" value="{{ user.name }}">
              <input id="profile_emp_id" name="emp_id" type="text" required class="border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-300" placeholder="Employee ID" value="{{ user.emp_id }}">
              <input id="profile_email" name="email" type="email" required class="border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-300" placeholder="Email" value="{{ user.email }}">
              <input id="profile_phone" name="phone" type="text" required class="border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-300" placeholder="Phone" value="{{ user.phone }}">
            </div>

            <div class="flex items-center gap-3">
              <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg">Save changes</button>
              <button type="button" id="cancelEditBtn" class="text-gray-600 px-4 py-2 rounded-lg border border-gray-200">Cancel</button>
            </div>

            <p id="profileMsg" class="text-sm mt-1 text-center"></p>
          </form>
        </div>

        <!-- OTP verification (hidden by default) -->
        <div id="otpCard" class="bg-white rounded-2xl shadow-sm p-6 hidden fade-slide">
          <h3 class="text-lg font-semibold text-gray-900">Verify Changes (OTP)</h3>
          <p class="text-sm text-gray-500 mt-1">Enter the OTP sent to your email / phone to confirm profile update.</p>

          <form id="otpForm" class="mt-4 space-y-4">
            <input id="profile_otp" name="otp" type="text" required class="border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-300" placeholder="Enter OTP">
            <div class="flex items-center gap-3">
              <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg">Verify OTP</button>
              <button id="resendOtpBtn" type="button" class="text-indigo-600 px-4 py-2 rounded-lg border border-indigo-100">Resend OTP</button>
            </div>
            <p id="otpMsg" class="text-sm mt-1 text-center"></p>
          </form>
        </div>

        <!-- Account / actions area -->
        <div class="bg-white rounded-2xl shadow-sm p-6 fade-slide">
          <div class="flex items-center justify-between">
            <div>
              <h4 class="text-lg font-semibold text-gray-900">Account Settings</h4>
              <p class="text-sm text-gray-500 mt-1">Manage account security and preferences.</p>
            </div>
            <div class="flex items-center gap-3">
              <a href="#" class="text-indigo-600 hover:underline text-sm">Change password</a>
              <a href="#" class="text-indigo-600 hover:underline text-sm">Two-factor</a>
            </div>
          </div>
        </div>

      </section>
    </div>
  </main>

  <!-- Toast container -->
  <div id="toast-container" class="fixed top-6 right-6 z-50 space-y-2"></div>

  <!-- Scripts -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      lucide.createIcons();

      // Elements
      const editProfileBtn = document.getElementById('editProfileBtn');
      const userInfoDiv = document.getElementById('userInfo');
      const profileForm = document.getElementById('profileForm');
      const profileMsg = document.getElementById('profileMsg');
      const cancelEditBtn = document.getElementById('cancelEditBtn');

      const otpCard = document.getElementById('otpCard');
      const otpForm = document.getElementById('otpForm');
      const otpMsg = document.getElementById('otpMsg');
      const resendOtpBtn = document.getElementById('resendOtpBtn');

      // helper: toast
      function showToast(message, type = "success") {
        const toast = document.createElement("div");
        toast.className = `px-4 py-2 rounded shadow text-white ${type === "error" ? "bg-red-500" : "bg-indigo-600"} fade-slide`;
        toast.textContent = message;
        document.getElementById("toast-container").appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
      }

      // Show edit form
      if (editProfileBtn) {
        editProfileBtn.addEventListener('click', () => {
          if (userInfoDiv) userInfoDiv.classList.add('hidden');
          if (profileForm) {
            profileForm.classList.remove('hidden');
            profileForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        });
      }

      // Cancel edit
      if (cancelEditBtn) {
        cancelEditBtn.addEventListener('click', () => {
          profileForm.classList.add('hidden');
          if (userInfoDiv) userInfoDiv.classList.remove('hidden');
          profileMsg.textContent = '';
        });
      }

      // Submit update profile
      if (profileForm) {
        profileForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          profileMsg.textContent = '';
          const name = document.getElementById('profile_name').value.trim();
          const emp_id = document.getElementById('profile_emp_id').value.trim();
          const email = document.getElementById('profile_email').value.trim();
          const phone = document.getElementById('profile_phone').value.trim();

          // Basic validation
          if (!name || !emp_id || !email || !phone) {
            profileMsg.textContent = 'Please fill all fields';
            profileMsg.className = 'text-sm text-red-600 mt-1 text-center';
            return;
          }

          try {
            const res = await fetch('/dashboard/update_profile', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name, emp_id, email, phone })
            });
            const data = await res.json();

            if (res.status === 200) {
              showToast(data.message || 'Profile update started');
              // If OTP flow triggered, show OTP card
              if (data.message && data.message.toLowerCase().includes('otp')) {
                profileForm.classList.add('hidden');
                otpCard.classList.remove('hidden');
                otpForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                otpMsg.textContent = '';
              } else {
                // success without OTP: reload to show updated info
                setTimeout(() => window.location.reload(), 900);
              }
            } else {
              profileMsg.textContent = data.error || 'Unable to update';
              profileMsg.className = 'text-sm text-red-600 mt-1 text-center';
            }
          } catch (err) {
            console.error(err);
            profileMsg.textContent = 'Server error, try again';
            profileMsg.className = 'text-sm text-red-600 mt-1 text-center';
          }
        });
      }

      // OTP submit
      if (otpForm) {
        otpForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          otpMsg.textContent = '';
          const otp = document.getElementById('profile_otp').value.trim();
          if (!otp) {
            otpMsg.textContent = 'Enter OTP';
            otpMsg.className = 'text-sm text-red-600 mt-1 text-center';
            return;
          }

          try {
            const res = await fetch('/dashboard/verify_update_otp', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ otp })
            });
            const data = await res.json();
            if (res.status === 200) {
              showToast(data.message || 'Profile updated');
              otpCard.classList.add('hidden');
              // refresh to show updated profile
              setTimeout(() => window.location.reload(), 900);
            } else {
              otpMsg.textContent = data.error || 'Invalid OTP';
              otpMsg.className = 'text-sm text-red-600 mt-1 text-center';
            }
          } catch (err) {
            console.error(err);
            otpMsg.textContent = 'Server error, try again';
            otpMsg.className = 'text-sm text-red-600 mt-1 text-center';
          }
        });
      }

      // Optional: resend OTP
      if (resendOtpBtn) {
        resendOtpBtn.addEventListener('click', async () => {
          resendOtpBtn.disabled = true;
          try {
            const res = await fetch('/dashboard/resend_update_otp', { method: 'POST' });
            const data = await res.json();
            if (res.ok) {
              showToast(data.message || 'OTP resent');
            } else {
              showToast(data.error || 'Could not resend OTP', 'error');
            }
          } catch (err) {
            console.error(err);
            showToast('Server error', 'error');
          } finally {
            setTimeout(() => { resendOtpBtn.disabled = false; }, 1500);
          }
        });
      }

      // Logout handler
const logoutLink = document.getElementById('logoutLink');

const handleLogout = async (e) => {
  e.preventDefault();

  const accessToken = localStorage.getItem('access_token');

  try {
    // Call the backend logout endpoint
    await fetch('/logout', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${accessToken}`
      }
    });
  } catch (error) {
    console.error('Logout API call failed, continuing client-side cleanup.');
  }

  // Remove tokens from localStorage
  localStorage.removeItem('access_token');
  localStorage.removeItem('refresh_token');

  // Delete cookies (for JWTs possibly stored in cookies)
  document.cookie.split(";").forEach(c => {
    document.cookie = c
      .replace(/^ +/, "")
      .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
  });

  // Redirect to login page
  window.location.href = '/login';
};

// ‚úÖ Attach logout event correctly
if (logoutLink) {
  logoutLink.addEventListener('click', handleLogout);
}

    }); // DOMContentLoaded end
  </script>
</body>
</html>
